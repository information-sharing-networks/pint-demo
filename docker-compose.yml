# docker-compose.yml (development env - mounts the local repo directory)
services:
  db:
    image: postgres:17-alpine
    restart: unless-stopped
    container_name: pint-demo-db
    volumes:
      - db-data-dev:/var/lib/postgresql/data
    ports:
      - "15433:5432"
    environment:
      POSTGRES_HOST_AUTH_METHOD: trust
      POSTGRES_USER: pint-dev
      POSTGRES_DB: pint_demo
    healthcheck:
      test: ["CMD-SHELL", "psql -U pint-dev -d pint_demo -c 'select 1;'"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - app-network
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 2048M

  app:
    build:
      context: .
      args:
        # GO_VERSION should be extracted from app/go.mod and exported.
        GO_VERSION: ${GO_VERSION}
      dockerfile_inline: |
        ARG GO_VERSION
        FROM golang:${GO_VERSION}-alpine

        # Install system dependencies in one layer for better caching
        RUN apk add --no-cache bash postgresql-client curl jq vim git

        # Install Go tools â€” versions pinned via go.mod/go.sum.
        # This layer is only rebuilt when go.sum changes, i.e. when a
        # tool or dependency version is deliberately updated.
        WORKDIR /build
        COPY app/tools.go app/go.mod app/go.sum ./
        RUN go mod download && \
            go install github.com/air-verse/air && \
            go install github.com/pressly/goose/v3/cmd/goose && \
            go install github.com/sqlc-dev/sqlc/cmd/sqlc && \
            go install github.com/swaggo/swag/cmd/swag && \
            go install honnef.co/go/tools/cmd/staticcheck && \
            go install github.com/securego/gosec/v2/cmd/gosec && \
            go install golang.org/x/vuln/cmd/govulncheck && \
            cd / && rm -rf /build

        WORKDIR /pint-demo

    container_name: pint-server
    volumes:
      - ./:/pint-demo # project dir
      - go-modules:/go/pkg/mod # persist downloaded modules
    environment:
      - DOCKER_ENV=true

      # Required PINT configuration - must be set in .env file
      - DATABASE_URL
      - REGISTRY_PATH
      - MANUAL_KEYS_DIR
      - SIGNING_KEY_PATH
      - PLATFORM_CODE

      # Optional x5c certificate configuration
      - X5C_CERT_PATH
      - X5C_CUSTOM_ROOTS_PATH

      # Optional overrides - pass through from shell if set, otherwise app uses defaults

      # HTTP server settings
      - HOST
      - PORT
      - ENVIRONMENT
      - LOG_LEVEL
      - PUBLIC_BASE_URL
      - SERVER_SHUTDOWN_TIMEOUT
      - READ_TIMEOUT
      - WRITE_TIMEOUT
      - IDLE_TIMEOUT
      - MAX_REQUEST_SIZE   

      # Database settings
      - DB_MAX_CONNECTIONS
      - DB_MIN_CONNECTIONS
      - DB_MAX_CONN_LIFETIME
      - DB_MAX_CONN_IDLE_TIME
      - DB_CONNECT_TIMEOUT
      - DATABASE_PING_TIMEOUT

      # Security and rate limiting
      - ALLOWED_ORIGINS
      - RATE_LIMIT_RPS
      - RATE_LIMIT_BURST
      - MIN_TRUST_LEVEL

      # JWK cache settings
      - SKIP_JWK_CACHE
      - JWK_CACHE_MIN_REFRESH
      - JWK_CACHE_MAX_REFRESH
      - JWK_CACHE_HTTP_TIMEOUT
      - JWK_CACHE_LOOKUP_TIMEOUT
      - REGISTRY_FETCH_TIMEOUT

      # Party validation configuration
      - PARTY_SERVICE_NAME
      - PARTY_SERVICE_BASE_URL

    working_dir: /pint-demo
    ports:
      - "${PORT:-8080}:${PORT:-8080}"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health/live"]
      interval: 5s
      timeout: 5s
      retries: 5
    depends_on:
      db:
        condition: service_healthy
    command: >
      sh -c "
        cd /pint-demo/app &&
        echo 'Generating sqlc files...' &&
        sqlc generate &&
        echo 'Running database migrations...' &&
        goose -dir sql/schema postgres $$DATABASE_URL -env=none up &&
        echo 'Starting pint-server service...' &&
        air
      "
    networks:
      - app-network
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M

networks:
  app-network:
    driver: bridge

volumes:
  db-data-dev:
  go-modules:

